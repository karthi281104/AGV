{% extends "base.html" %}

{% block title %}Dashboard - AGV Finance & Loans{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="dashboard-title">
                <i class="fas fa-chart-line me-3"></i>Finance Dashboard
            </h1>
            <p class="text-muted">Real-time insights into your financial operations</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="dashboard-controls">
                <div class="btn-group me-2" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" id="exportBtn">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
                <span class="badge bg-success connection-status" id="connectionStatus">
                    <i class="fas fa-wifi me-1"></i>Connected
                </span>
            </div>
            <div class="last-updated mt-2">
                <small class="text-muted">Last updated: <span id="lastUpdated">Loading...</span></small>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="quick-actions">
                <a href="{{ url_for('customer.add_customer') }}" class="btn btn-primary me-2">
                    <i class="fas fa-user-plus me-1"></i>Add Customer
                </a>
                <a href="{{ url_for('loan.loan_form') }}" class="btn btn-success me-2">
                    <i class="fas fa-coins me-1"></i>New Loan
                </a>
                <a href="{{ url_for('payment.payment_form') }}" class="btn btn-info me-2">
                    <i class="fas fa-credit-card me-1"></i>Record Payment
                </a>
                <button class="btn btn-outline-secondary" id="searchToggle">
                    <i class="fas fa-search me-1"></i>Search
                </button>
            </div>
        </div>
    </div>

    <!-- Search Bar (Initially Hidden) -->
    <div class="row mb-3 d-none" id="searchRow">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search customers, loans, payments...">
                <button class="btn btn-outline-secondary" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Metrics Grid (3x3 Layout) -->
    <div class="row g-4 mb-5">
        <!-- Total Customers Card -->
        <div class="col-lg-4 col-md-6">
            <div class="metric-card card h-100" id="customersCard">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Total Customers</h6>
                            <h2 class="card-title mb-0" id="totalCustomers">
                                <span class="loading-skeleton">Loading...</span>
                            </h2>
                            <div class="metric-trend mt-1" id="customersTrend">
                                <span class="trend-indicator">
                                    <i class="fas fa-arrow-up text-success"></i>
                                    <span class="trend-value">--</span>
                                </span>
                                <small class="text-muted ms-1">vs last month</small>
                            </div>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-users text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Disbursed Card -->
        <div class="col-lg-4 col-md-6">
            <div class="metric-card card h-100" id="disbursedCard">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Total Disbursed</h6>
                            <h2 class="card-title mb-0" id="totalDisbursed">
                                <span class="loading-skeleton">Loading...</span>
                            </h2>
                            <div class="metric-trend mt-1" id="disbursedTrend">
                                <span class="trend-indicator">
                                    <i class="fas fa-arrow-up text-success"></i>
                                    <span class="trend-value">--</span>
                                </span>
                                <small class="text-muted ms-1">portfolio value</small>
                            </div>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-coins text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interest Earned Card -->
        <div class="col-lg-4 col-md-6">
            <div class="metric-card card h-100" id="interestCard">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Interest Earned</h6>
                            <h2 class="card-title mb-0" id="totalInterest">
                                <span class="loading-skeleton">Loading...</span>
                            </h2>
                            <div class="metric-trend mt-1" id="interestTrend">
                                <span class="trend-indicator">
                                    <i class="fas fa-percentage text-info"></i>
                                    <span class="trend-value">--</span>
                                </span>
                                <small class="text-muted ms-1">yield rate</small>
                            </div>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-chart-line text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overdue Amount Card -->
        <div class="col-lg-4 col-md-6">
            <div class="metric-card card h-100" id="overdueCard">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Overdue Amount</h6>
                            <h2 class="card-title mb-0" id="overdueAmount">
                                <span class="loading-skeleton">Loading...</span>
                            </h2>
                            <div class="metric-trend mt-1" id="overdueTrend">
                                <span class="trend-indicator">
                                    <i class="fas fa-exclamation-triangle text-warning"></i>
                                    <span class="trend-value">--</span>
                                </span>
                                <small class="text-muted ms-1">default rate</small>
                            </div>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-exclamation-circle text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Loans Card -->
        <div class="col-lg-4 col-md-6">
            <div class="metric-card card h-100" id="activeLoansCard">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Active Loans</h6>
                            <h2 class="card-title mb-0" id="activeLoans">
                                <span class="loading-skeleton">Loading...</span>
                            </h2>
                            <div class="metric-trend mt-1" id="loansTrend">
                                <span class="trend-indicator">
                                    <i class="fas fa-arrow-up text-success"></i>
                                    <span class="trend-value">--</span>
                                </span>
                                <small class="text-muted ms-1">vs last month</small>
                            </div>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-file-contract text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Collections Card -->
        <div class="col-lg-4 col-md-6">
            <div class="metric-card card h-100" id="collectionsCard">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Monthly Collections</h6>
                            <h2 class="card-title mb-0" id="monthlyCollections">
                                <span class="loading-skeleton">Loading...</span>
                            </h2>
                            <div class="metric-trend mt-1" id="collectionsTrend">
                                <span class="trend-indicator">
                                    <i class="fas fa-arrow-up text-success"></i>
                                    <span class="trend-value">--</span>
                                </span>
                                <small class="text-muted ms-1">efficiency</small>
                            </div>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-money-bill-wave text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Visualizations -->
    <div class="row g-4 mb-5">
        <!-- Portfolio Breakdown Chart -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Portfolio Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="portfolioChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Monthly Trends Chart -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Monthly Trends
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="trendsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities and Notifications -->
    <div class="row g-4">
        <!-- Recent Activities -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activities
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshActivities">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="recentActivities" class="activity-list">
                        <div class="loading-spinner text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell me-2"></i>Notifications
                        <span class="badge bg-danger ms-2" id="notificationBadge">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="notificationsPanel">
                        <div class="text-center py-4">
                            <i class="fas fa-bell-slash text-muted fs-3"></i>
                            <p class="text-muted mt-2">No new notifications</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay d-none" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Updating dashboard...</p>
    </div>
</div>

<!-- Search Results Modal -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="searchResults">
                <!-- Search results will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}